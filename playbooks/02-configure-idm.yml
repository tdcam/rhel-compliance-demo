---
- name: Configure IdM server and populate dummy users
  hosts: all
  become: true

  vars:
    ipa_domain: sandbox1108.opentlc.com
    ipa_realm: SANDBOX1108.OPENTLC.COM
    ipa_admin_user: admin
    ipa_admin_password: red22hat
    dummy_users:
      - { username: lmorales, first: Leo, last: Morales }
      - { username: qscott, first: Quinn, last: Scott }
      - { username: adiaz, first: Andrew, last: Diaz }
      - { username: nchavez, first: Nolan, last: Chavez }
      - { username: gtorres, first: Gianna, last: Torres }
      - { username: sjackson, first: Serenity, last: Jackson }
      - { username: lreyes, first: Lucas, last: Reyes }
      - { username: mlopez, first: Muhammad, last: Lopez }

  tasks:
    - name: Install IdM server packages
      dnf:
        name: ipa-server
        state: present

    - name: Install IdM server with integrated DNS
      command: >
        ipa-server-install --unattended
        --realm {{ ipa_realm }}
        --domain {{ ipa_domain }}
        --ds-password {{ ipa_admin_password }}
        --admin-password {{ ipa_admin_password }}
        --setup-dns --no-forwarders
      args:
        creates: /etc/ipa/default.conf

    - name: Ensure Kerberos credentials for IPA admin
      shell: echo "{{ ipa_admin_password }}" | kinit {{ ipa_admin_user }}@{{ ipa_realm }}
      register: kinit_result
      changed_when: false
      failed_when: kinit_result.rc != 0

    - name: Create dummy IdM users
      command: >
        ipa user-add {{ item.username }}
        --first {{ item.first }}
        --last {{ item.last }}
        --homedir /home/{{ item.username }}
        --shell /bin/bash
      loop: "{{ dummy_users }}"

    - name: Set passwords and expiration for dummy users
      shell: |
        echo "{{ ipa_admin_password }}" | kinit {{ ipa_admin_user }}@{{ ipa_realm }}
        echo "{{ ipa_admin_password }}" | ipa passwd {{ item.username }}
        ipa user-mod {{ item.username }} --setattr=krbPasswordExpiration=20301231011529
      loop: "{{ dummy_users }}"

